<!doctype html>
<html class="no-js" lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wungchungery Simulator</title>
    <link rel="stylesheet" href="css/foundation-icons.css" />
    <link rel="stylesheet" href="css/foundation.css" />
    <link rel="stylesheet" href="css/app.css" />
  </head>
  <body>
    <div class="grid-container">
      <div class="grid-x grid-padding-x">
        <div class="large-8 cell">
          <div id="wch-progress" class="progress" role="progressbar" tabindex="0"
               aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
               <div class="progress-meter"></div>
          </div>
          <canvas id="wch-simulation" oncontextmenu="event.preventDefault()"></canvas>
        </div>
        <div class="large-4 cell">

          <ul id="wch-control-panel" class="tabs" data-tabs>
            <li class="tabs-title is-active"><a href="#commandpanel">Commands</a></li>
            <li class="tabs-title"><a href="#outputpanel">Output console</a></li>
          </ul>

          <div class="tabs-content" data-tabs-content="wch-control-panel">
            <div id="commandpanel" class="tabs-panel is-active">
                <div class="button-group">
                    <a id="wch-start" href="#" class="button"><i class="fi-play"></i></a>
                    <a id="wch-stop" href="#" class="button"><i class="fi-stop"></i></a>
                    <a id="wch-pause" href="#" class="button"><i class="fi-pause"></i></a>
                </div>
                <textarea id="wch-command" placeholder="Enter a command..."></textarea>
                <div class="button-group">
                    <a id="wch-execute" href="#" class="button">Execute</a>
                </div>
            </div>
            <div id="outputpanel" class="tabs-panel">
                <label>
                  <p>Output console</p>
                  <textarea id="wch-output" rows="10"></textarea>
                </label>
            </div>
          </div>

        </div>
      </div> <!-- Grid x -->
    </div> <!-- Grid container -->

    <script src="js/jquery.js"></script>
    <script src="js/what-input.js"></script>
    <script src="js/foundation.js"></script>

    <script src="engine.js"></script>
    <script>
      $(document).foundation();

      (function(wch){
        var progressElement = document.getElementById('wch-progress');
        var Module = {
          arguments: ["-s", "/scripts"],

          preRun: [],

          postRun: [],

          print: (function() {
            var element = document.getElementById('wch-output');
            if (element) element.value = ''; // clear browser cache
            return function(text) {
              if (arguments.length > 1) text = Array.prototype.slice.call(arguments).join(' ');
              // These replacements are necessary if you render to raw HTML
              //text = text.replace(/&/g, "&amp;");
              //text = text.replace(/</g, "&lt;");
              //text = text.replace(/>/g, "&gt;");
              //text = text.replace('\n', '<br>', 'g');
              console.log(text);
              if (element) {
                element.value += text + "\n";
                element.scrollTop = element.scrollHeight; // focus on bottom
              }
            };
          })(),
          
          printErr: function(text) {
            if (arguments.length > 1) text = Array.prototype.slice.call(arguments).join(' ');
            if (0) { // XXX disabled for safety typeof dump == 'function') {
              dump(text + '\n'); // fast, straight to the real console
            } else {
              console.error(text);
            }
          },

          canvas: (function() {
            var canvas = document.getElementById('wch-simulation');

            // As a default initial behavior, pop up an alert when webgl context is lost. To make your
            // application robust, you may want to override this behavior before shipping!
            // See http://www.khronos.org/registry/webgl/specs/latest/1.0/#5.15.2
            canvas.addEventListener("webglcontextlost", function(e) { alert('WebGL context lost. You will need to reload the page.'); e.preventDefault(); }, false);
            return canvas;
          })(),

          setStatus: function(text) {
            if (!Module.setStatus.last) Module.setStatus.last = { time: Date.now(), text: '' };
            if (text === Module.setStatus.text) return;
            var m = text.match(/([^(]+)\((\d+(\.\d+)?)\/(\d+)\)/);
            var now = Date.now();
            if (m && now - Date.now() < 30) return; // if this is a progress update, skip it if too soon
            if (m) {
              text = m[1];
              progressElement.getElementsByClassName("progress-meter")[0].style.width = string(parseInt(m[2])*100) + '%';
              //progressElement.max = parseInt(m[4])*100;
              progressElement.hidden = false;

            } else {
              progressElement.getElementsByClassName("progress-meter")[0].style.width = '100%';
              //progressElement.max = null;
              progressElement.hidden = true;
            }
            console.info(text);
          },

          totalDependencies: 0,

          monitorRunDependencies: function(left) {
            this.totalDependencies = Math.max(this.totalDependencies, left);
            Module.setStatus(left ? 'Preparing... (' + (this.totalDependencies-left) + '/' + this.totalDependencies + ')' : 'All downloads complete.');
          },
        };
        Module.setStatus('Downloading...');


        window.onerror = function() {
          Module.setStatus('Exception thrown, see JavaScript console');
          Module.setStatus = function(text) {
            if (text) Module.printErr('[post-exception status] ' + text);
          };
        };

        //wch(Module);

      })(WCH);
    </script>

  </body>
</html>
